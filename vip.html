<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CitasPro ‚Äî Auto-agenda VIP</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg">
  <header class="topbar">
    <div class="brand">
      <img id="brandLogo" class="logo" src="assets/default-logo.svg" alt="logo" />
      <div>
        <h1 id="brandTitle">CitasPro</h1>
        <small class="muted">Auto-agenda VIP</small>
      </div>
    </div>
    <nav class="top-actions">
      <a class="btn" href="index.html">Volver</a>
    </nav>
  </header>

  <main class="card">
    <h2>Auto-agenda VIP</h2>
    <p class="muted">Selecciona fecha, hora y el empleado</p>

    <div id="calendar" class="calendar" aria-label="Calendario de reservas"></div>

    <form id="vipForm" class="stack" style="max-width:520px;margin:auto;">
      <input id="vipName" placeholder="Tu nombre" required>
      <input id="vipPhone" placeholder="WhatsApp (con c√≥digo de pa√≠s)" required>
      <input id="vipService" placeholder="Servicio" required>
      <select id="vipDuration">
        <option value="60">60 min</option>
        <option value="90">90 min</option>
      </select>
      <select id="vipEmployee" required></select>
      <input id="vipDate" type="date" required>
      <input id="vipTime" type="time" required>
      <button class="btn primary" type="submit">Reservar</button>
    </form>

    <div id="vipMsg" class="muted" style="text-align:center;margin-top:8px"></div>
  </main>

  <footer class="foot">Hecho con ‚ù§ ‚Äî CitasPro</footer>

  <script src="storage.js"></script>
  <script src="calendar.js"></script>
  <script>
  (function(){
    Storage.bootstrapUI();
    const q = new URLSearchParams(location.search);
    const token = q.get('t');
    if(!Storage.validateVip(token)){
      document.body.innerHTML = '<main class="card"><h2>Enlace inv√°lido</h2><p>Pide un enlace v√°lido a tu negocio.</p><p><a class="btn" href="index.html">Ir al inicio</a></p></main>';
      return;
    }

    // Empleados din√°micos
    Storage.ensureEmployees();
    const selEmp = document.getElementById('vipEmployee');
    selEmp.innerHTML = Storage.getEmployees().map(e=>`<option>${e}</option>`).join('');

    const cal = document.getElementById('calendar');
    let selected = new Date();

    function drawCalendar(){
      renderCalendar(
        cal,
        selected,
        (d)=>{ selected=d; const vipDate=document.getElementById('vipDate'); if(vipDate) vipDate.valueAsDate=d; },
        (ymd)=> Storage.listAppointments().filter(a=>a.date===ymd).length
      );
    }
    drawCalendar();

    const vipDate = document.getElementById('vipDate'); 
    if(vipDate) vipDate.valueAsDate = selected;

    const form = document.getElementById('vipForm');
    const msgBox = document.getElementById('vipMsg');

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const appt = {
        name: document.getElementById('vipName').value.trim(),
        phone: document.getElementById('vipPhone').value.trim(),
        service: document.getElementById('vipService').value.trim(),
        employee: selEmp.value,
        date: (document.getElementById('vipDate').value || '').slice(0,10),
        time: (document.getElementById('vipTime').value || '').slice(0,5),
        duration: Number(document.getElementById('vipDuration').value||60),
        price: 0,
        source: 'vip'
      };

      if(!Storage.canSchedule(appt)){
        alert('Ese horario ya est√° ocupado para ' + appt.employee + '. Elige otra hora o empleado.');
        return;
      }

      Storage.saveAppointment(appt);
      if(msgBox) msgBox.textContent = '¬°Listo! Tu cita qued√≥ registrada.';
      form.reset();
      drawCalendar();
    });
  })();
  </script>
</body>
</html>
Storage.saveAppointment(appt);

// üîó sincroniza con Google Calendar
if (window.AppPush) { AppPush(appt); }

if(msgBox) msgBox.textContent = '¬°Listo! Tu cita qued√≥ registrada.';
form.reset();
drawCalendar();

