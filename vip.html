<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cynthia's Salon — Auto-agenda VIP</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg">
  <header class="topbar">
    <div class="brand">
      <img id="brandLogo" class="logo" src="assets/default-logo.svg" alt="logo" />
      <div>
        <h1 id="brandTitle">Cynthia's Salon</h1>
        <small class="muted">Auto-agenda VIP</small>
      </div>
    </div>
    <nav class="top-actions">
      <a class="btn" href="index.html">Volver</a>
    </nav>
  </header>

  <main class="card">
    <h2>Auto-agenda VIP</h2>
    <p class="muted">Selecciona fecha, hora y el empleado</p>

    <!-- Calendario -->
    <div id="calendar" class="calendar" aria-label="Calendario de reservas"></div>

    <!-- Formulario VIP -->
    <form id="vipForm" class="stack" style="max-width:520px;margin:auto;">
      <input id="vipName" placeholder="Tu nombre" required>
      <input id="vipPhone" placeholder="WhatsApp (con código de país)" required>
      <input id="vipService" placeholder="Servicio" required>
      <select id="vipDuration">
        <option value="60">60 min</option>
        <option value="90">90 min</option>
      </select>
      <select id="vipEmployee" required></select>
      <input id="vipDate" type="date" required>
      <input id="vipTime" type="time" required>
      <button class="btn primary" type="submit">Reservar</button>
    </form>

    <div id="vipMsg" class="muted" style="text-align:center;margin-top:8px"></div>
  </main>

  <footer class="foot">Hecho con ❤ — Cynthia's Salon</footer>

  <!-- Scripts -->
  <script src="storage.js"></script>
  <script src="calendar.js"></script>
  <script src="app.js"></script>
  <script>
  (function(){
    // Branding
    Storage.bootstrapUI();

    // Validar token VIP
    const q = new URLSearchParams(location.search);
    const token = q.get('t');
    if(!Storage.validateVip(token)){
      document.body.innerHTML = '<main class="card"><h2>Enlace inválido</h2><p>Pide un enlace válido a tu negocio.</p><p><a class="btn" href="index.html">Ir al inicio</a></p></main>';
      return;
    }

    // Empleados dinámicos
    Storage.ensureEmployees();
    const selEmp = document.getElementById('vipEmployee');
    selEmp.innerHTML = Storage.getEmployees().map(e=>`<option>${e}</option>`).join('');

    // Calendario con contador de citas por día
    const cal = document.getElementById('calendar');
    let selected = new Date();
    function drawCalendar(){
      renderCalendar(
        cal,
        selected,
        (d)=>{ 
          selected = d; 
          const vipDate=document.getElementById('vipDate'); 
          if(vipDate) vipDate.valueAsDate=d; 
        },
        (ymd)=> Storage.listAppointments().filter(a=>a.date===ymd).length,
        selected
      );
    }
    drawCalendar();

    // Preseleccionar fecha de hoy
    const vipDate = document.getElementById('vipDate'); 
    if(vipDate) vipDate.valueAsDate = selected;

    // Envío de reserva VIP
    const form = document.getElementById('vipForm');
    const msgBox = document.getElementById('vipMsg');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const appt = {
        id: null, // se asigna al guardar
        name: document.getElementById('vipName').value.trim(),
        phone: document.getElementById('vipPhone').value.trim(),
        service: document.getElementById('vipService').value.trim(),
        employee: selEmp.value,
        date: (document.getElementById('vipDate').value || '').slice(0,10),
        time: (document.getElementById('vipTime').value || '').slice(0,5),
        duration: Number(document.getElementById('vipDuration').value||60),
        price: 0,
        notes: '',
        source: 'vip'
      };

      // Anti-choques por empleado
      if(!Storage.canSchedule(appt)){
        alert('Ese horario ya está ocupado para ' + appt.employee + '. Elige otra hora o empleado.');
        return;
      }

      // Guardar local
      const saved = Storage.saveAppointment(appt);

      // Sincronizar con Google Calendar (usa configuración en settings)
      if (window.AppPush) {
        try { await AppPush(saved); } catch(e){ console.warn('No se pudo sincronizar con Google Calendar', e); }
      }

      if(msgBox) msgBox.textContent = '¡Listo! Tu cita quedó registrada.';
      form.reset();
      if(vipDate) vipDate.valueAsDate = selected;
      drawCalendar(); // refrescar contadores
    });
  })();
  </script>
</body>
</html>
